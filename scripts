# PowerShell Batch Prediction Test Script
# Usage: .\test_batch_simple.ps1

# Add required .NET assemblies
Add-Type -AssemblyName System.Net.Http

# Get the script directory
$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path

$url = "http://localhost:5001/predict/batch?prob_thresh=0.001"
$inputFile = Join-Path $scriptDir "example_input.txt"
$outputFile = Join-Path $scriptDir "results.xlsx"

Write-Host "=================================================="
Write-Host "CFM-ID Batch Prediction Test"
Write-Host "=================================================="
Write-Host "Input file: $inputFile"
Write-Host "Probability threshold: 0.001"
Write-Host "Processing..."

if (-not (Test-Path $inputFile)) {
    Write-Host "ERROR: Input file '$inputFile' not found" -ForegroundColor Red
    exit 1
}

try {
    $httpClient = New-Object System.Net.Http.HttpClient
    $multipartContent = New-Object System.Net.Http.MultipartFormDataContent
    
    $fileStream = [System.IO.File]::OpenRead($inputFile)
    $streamContent = New-Object System.Net.Http.StreamContent($fileStream)
    $streamContent.Headers.ContentType = New-Object System.Net.Http.Headers.MediaTypeHeaderValue("text/plain")
    
    $multipartContent.Add($streamContent, "file", [System.IO.Path]::GetFileName($inputFile))
    
    $response = $httpClient.PostAsync($url, $multipartContent).Result
    
    if ($response.IsSuccessStatusCode) {
        $responseBytes = $response.Content.ReadAsByteArrayAsync().Result
        [System.IO.File]::WriteAllBytes($outputFile, $responseBytes)
        
        $fileSize = (Get-Item $outputFile).Length / 1KB
        Write-Host "SUCCESS: Prediction completed!" -ForegroundColor Green
        Write-Host "Output file: $outputFile"
        Write-Host "File size: $([math]::Round($fileSize, 2)) KB"
    } else {
        $errorContent = $response.Content.ReadAsStringAsync().Result
        Write-Host "ERROR: HTTP $($response.StatusCode)" -ForegroundColor Red
        Write-Host "Response: $errorContent"
        exit 1
    }
    
    $fileStream.Close()
    $httpClient.Dispose()
} catch {
    Write-Host "ERROR: $_" -ForegroundColor Red
    exit 1
}

